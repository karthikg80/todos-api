<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App - Complete</title>
    <style>
        :root {
            /* Light mode colors */
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --container-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border-color: #e0e0e0;
            --input-bg: #ffffff;
            --card-bg: #f8f9fa;
            --card-hover: #f0f1f3;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body.dark-mode {
            /* Dark mode colors */
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --container-bg: #0f3460;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border-color: #27272a;
            --input-bg: #18181b;
            --card-bg: #27272a;
            --card-hover: #3f3f46;
            --shadow: rgba(0, 0, 0, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
        }

        .container {
            background: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px var(--shadow);
            max-width: 800px;
            margin: 0 auto;
            overflow: hidden;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .user-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .verified-badge {
            background: rgba(46, 213, 115, 0.3);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .unverified-badge {
            background: rgba(255, 107, 107, 0.3);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .admin-badge {
            background: rgba(255, 218, 121, 0.3);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(180deg);
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95em;
            color: #6c757d;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            color: #667eea;
            background: white;
            border-bottom-color: #667eea;
        }

        .content {
            padding: 30px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .auth-container {
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #999;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .auth-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .link-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.9em;
            margin-top: 15px;
        }

        .link-btn:hover {
            color: #764ba2;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.error {
            background: #fee;
            color: #c33;
        }

        .message.success {
            background: #efe;
            color: #3c3;
        }

        .message.warning {
            background: #fffbeb;
            color: #f59e0b;
            border: 1px solid #fde68a;
        }

        .add-todo {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .add-todo input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .add-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .todos-list {
            list-style: none;
        }

        .todo-item {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
        }

        .todo-item:hover {
            background: var(--card-hover);
        }

        .todo-item.completed {
            opacity: 0.6;
        }

        .todo-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .todo-content {
            flex: 1;
        }

        .todo-title {
            font-weight: 500;
            color: var(--text-primary);
        }

        .todo-item.completed .todo-title {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .delete-btn {
            padding: 8px 16px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .delete-btn:hover {
            background: #ff3838;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .profile-section {
            margin-bottom: 30px;
        }

        .profile-section h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .info-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .info-value {
            color: var(--text-primary);
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-table th, .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .users-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .role-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .role-badge.admin {
            background: #fff3cd;
            color: #856404;
        }

        .role-badge.user {
            background: #d1ecf1;
            color: #0c5460;
        }

        .action-btn {
            padding: 6px 12px;
            margin: 0 4px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .action-btn.promote {
            background: #ffc107;
            color: #000;
        }

        .action-btn.demote {
            background: #6c757d;
            color: white;
        }

        .action-btn.delete {
            background: #dc3545;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .container {
                border-radius: 0;
            }

            .add-todo {
                flex-direction: column;
            }

            .users-table {
                font-size: 0.85em;
            }

            .action-btn {
                padding: 4px 8px;
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>üìù Todo App</h1>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">üåô</button>
            </div>
            <div class="user-bar" id="userBar" style="display: none;">
                <div class="user-info">
                    <span id="userEmail"></span>
                    <span id="verifiedBadge"></span>
                    <span id="adminBadge"></span>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Navigation Tabs (only visible when logged in) -->
        <div class="nav-tabs" id="navTabs" style="display: none;">
            <button class="nav-tab active" onclick="switchView('todos')">Todos</button>
            <button class="nav-tab" onclick="switchView('profile')">Profile</button>
            <button class="nav-tab" id="adminNavTab" style="display: none;" onclick="switchView('admin')">Admin</button>
        </div>

        <div class="content">
            <!-- Authentication View -->
            <div id="authView" class="view active">
                <div class="auth-container">
                    <div class="auth-tabs">
                        <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                        <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
                    </div>

                    <div class="message" id="authMessage"></div>

                    <!-- Login Form -->
                    <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)" style="display: block;">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="loginEmail" required placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <button type="submit" class="btn">Login</button>
                        <button type="button" class="link-btn" onclick="showForgotPassword()">Forgot Password?</button>
                    </form>

                    <!-- Register Form -->
                    <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)" style="display: none;">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="registerName" placeholder="Your Name (optional)">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="registerEmail" required placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="registerPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8">
                        </div>
                        <button type="submit" class="btn">Create Account</button>
                    </form>

                    <!-- Forgot Password Form -->
                    <form id="forgotPasswordForm" class="auth-form" onsubmit="handleForgotPassword(event)" style="display: none;">
                        <h2 style="margin-bottom: 20px;">Reset Password</h2>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="forgotEmail" required placeholder="your@email.com">
                        </div>
                        <button type="submit" class="btn">Send Reset Link</button>
                        <button type="button" class="link-btn" onclick="showLogin()">Back to Login</button>
                    </form>

                    <!-- Reset Password Form -->
                    <form id="resetPasswordForm" class="auth-form" onsubmit="handleResetPassword(event)" style="display: none;">
                        <h2 style="margin-bottom: 20px;">Set New Password</h2>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" id="newPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password</label>
                            <input type="password" id="confirmPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8">
                        </div>
                        <button type="submit" class="btn">Reset Password</button>
                    </form>
                </div>
            </div>

            <!-- Todos View -->
            <div id="todosView" class="view">
                <div class="add-todo">
                    <input type="text" id="todoInput" placeholder="What needs to be done?" onkeypress="handleTodoKeyPress(event)">
                    <button class="add-btn" onclick="addTodo()">Add</button>
                </div>
                <div id="todosContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading todos...
                    </div>
                </div>
            </div>

            <!-- Profile View -->
            <div id="profileView" class="view">
                <div class="message" id="profileMessage"></div>

                <div class="profile-section">
                    <h3>Account Information</h3>
                    <div class="info-row">
                        <span class="info-label">Email:</span>
                        <span class="info-value" id="profileEmail"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Name:</span>
                        <span class="info-value" id="profileName"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="profileStatus"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Member Since:</span>
                        <span class="info-value" id="profileCreated"></span>
                    </div>
                </div>

                <div class="profile-section">
                    <h3>Update Profile</h3>
                    <form onsubmit="handleUpdateProfile(event)">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="updateName" placeholder="Your Name">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="updateEmail" required placeholder="your@email.com">
                        </div>
                        <button type="submit" class="btn">Update Profile</button>
                    </form>
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="view">
                <div class="message" id="adminMessage"></div>
                <h2>User Management</h2>
                <div id="adminContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading users...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000'
            : 'https://todos.karthikg.in';

        let currentUser = null;
        let authToken = null;
        let refreshToken = null;
        let todos = [];
        let users = [];

        // Initialize app
        function init() {
            // Check for reset token in URL
            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('token');

            if (resetToken) {
                showResetPassword(resetToken);
                return;
            }

            const token = localStorage.getItem('authToken');
            const refresh = localStorage.getItem('refreshToken');
            const user = localStorage.getItem('user');

            if (token && user) {
                authToken = token;
                refreshToken = refresh;
                currentUser = JSON.parse(user);
                showAppView();
                loadUserProfile();
            }
        }

        // API call with auto-refresh
        async function apiCall(url, options = {}) {
            if (!options.headers) options.headers = {};
            if (authToken && !options.skipAuth) {
                options.headers['Authorization'] = `Bearer ${authToken}`;
            }

            let response = await fetch(url, options);

            // Handle token expiration
            if (response.status === 401 && refreshToken && !options.skipRefresh) {
                const refreshed = await refreshAccessToken();
                if (refreshed) {
                    options.headers['Authorization'] = `Bearer ${authToken}`;
                    response = await fetch(url, options);
                } else {
                    logout();
                    return null;
                }
            }

            return response;
        }

        // Refresh access token
        async function refreshAccessToken() {
            try {
                const response = await fetch(`${API_URL}/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    refreshToken = data.refreshToken;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    return true;
                }
            } catch (error) {
                console.error('Token refresh failed:', error);
            }
            return false;
        }

        // Switch auth tabs
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.style.display = 'none');

            event.target.classList.add('active');
            document.getElementById(tab + 'Form').style.display = 'block';
            hideMessage('authMessage');
        }

        // Show forgot password form
        function showForgotPassword() {
            document.querySelectorAll('.auth-form').forEach(f => f.style.display = 'none');
            document.getElementById('forgotPasswordForm').style.display = 'block';
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            hideMessage('authMessage');
        }

        // Show login form
        function showLogin() {
            document.querySelectorAll('.auth-form').forEach(f => f.style.display = 'none');
            document.getElementById('loginForm').style.display = 'block';
            document.querySelectorAll('.auth-tab')[0].classList.add('active');
            hideMessage('authMessage');
        }

        // Show reset password form
        function showResetPassword(token) {
            document.getElementById('resetPasswordForm').dataset.token = token;
            document.querySelectorAll('.auth-form').forEach(f => f.style.display = 'none');
            document.getElementById('resetPasswordForm').style.display = 'block';
        }

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();
            hideMessage('authMessage');

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    refreshToken = data.refreshToken;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    if (refreshToken) localStorage.setItem('refreshToken', refreshToken);
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    showAppView();
                    loadUserProfile();
                } else {
                    showMessage('authMessage', data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showMessage('authMessage', 'Network error. Please try again.', 'error');
                console.error('Login error:', error);
            }
        }

        // Handle registration
        async function handleRegister(event) {
            event.preventDefault();
            hideMessage('authMessage');

            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            const payload = { email, password };
            if (name) payload.name = name;

            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    refreshToken = data.refreshToken;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    if (refreshToken) localStorage.setItem('refreshToken', refreshToken);
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    showMessage('authMessage', 'Account created successfully!', 'success');
                    setTimeout(() => {
                        showAppView();
                        loadUserProfile();
                    }, 1000);
                } else {
                    if (data.errors) {
                        const errorMsg = data.errors.map(e => e.message).join(', ');
                        showMessage('authMessage', errorMsg, 'error');
                    } else {
                        showMessage('authMessage', data.error || 'Registration failed', 'error');
                    }
                }
            } catch (error) {
                showMessage('authMessage', 'Network error. Please try again.', 'error');
                console.error('Registration error:', error);
            }
        }

        // Handle forgot password
        async function handleForgotPassword(event) {
            event.preventDefault();
            hideMessage('authMessage');

            const email = document.getElementById('forgotEmail').value;

            try {
                const response = await fetch(`${API_URL}/auth/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('authMessage', data.message || 'Reset link sent! Check your email.', 'success');
                    setTimeout(showLogin, 3000);
                } else {
                    showMessage('authMessage', data.error || 'Failed to send reset link', 'error');
                }
            } catch (error) {
                showMessage('authMessage', 'Network error. Please try again.', 'error');
                console.error('Forgot password error:', error);
            }
        }

        // Handle reset password
        async function handleResetPassword(event) {
            event.preventDefault();
            hideMessage('authMessage');

            const token = document.getElementById('resetPasswordForm').dataset.token;
            const password = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;

            if (password !== confirm) {
                showMessage('authMessage', 'Passwords do not match', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, password })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('authMessage', 'Password reset successfully! Redirecting to login...', 'success');
                    setTimeout(() => {
                        window.location.href = window.location.pathname;
                    }, 2000);
                } else {
                    showMessage('authMessage', data.error || 'Failed to reset password', 'error');
                }
            } catch (error) {
                showMessage('authMessage', 'Network error. Please try again.', 'error');
                console.error('Reset password error:', error);
            }
        }

        // Load user profile
        async function loadUserProfile() {
            try {
                const response = await apiCall(`${API_URL}/users/me`);
                if (response && response.ok) {
                    const user = await response.json();
                    currentUser = { ...currentUser, ...user };
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    updateUserDisplay();

                    // Check if admin and show admin tab
                    if (user.role === 'admin') {
                        document.getElementById('adminNavTab').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Load profile error:', error);
            }
        }

        // Update user display
        function updateUserDisplay() {
            document.getElementById('userEmail').textContent = currentUser.email;

            const verifiedBadge = document.getElementById('verifiedBadge');
            if (currentUser.isVerified) {
                verifiedBadge.className = 'verified-badge';
                verifiedBadge.textContent = '‚úì Verified';
            } else {
                verifiedBadge.className = 'unverified-badge';
                verifiedBadge.textContent = 'Not Verified';
            }

            const adminBadge = document.getElementById('adminBadge');
            if (currentUser.role === 'admin') {
                adminBadge.className = 'admin-badge';
                adminBadge.textContent = '‚≠ê Admin';
                adminBadge.style.display = 'inline-block';
            } else {
                adminBadge.style.display = 'none';
            }

            // Update profile view
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileName').textContent = currentUser.name || 'Not set';
            document.getElementById('profileStatus').textContent = currentUser.isVerified ? 'Verified ‚úì' : 'Not Verified';
            document.getElementById('profileCreated').textContent = new Date(currentUser.createdAt).toLocaleDateString();
            document.getElementById('updateName').value = currentUser.name || '';
            document.getElementById('updateEmail').value = currentUser.email;
        }

        // Handle update profile
        async function handleUpdateProfile(event) {
            event.preventDefault();
            hideMessage('profileMessage');

            const name = document.getElementById('updateName').value;
            const email = document.getElementById('updateEmail').value;

            try {
                const response = await apiCall(`${API_URL}/users/me`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name || null, email })
                });

                if (response && response.ok) {
                    const updatedUser = await response.json();
                    currentUser = { ...currentUser, ...updatedUser };
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    updateUserDisplay();
                    showMessage('profileMessage', 'Profile updated successfully!', 'success');
                } else {
                    const data = await response.json();
                    showMessage('profileMessage', data.error || 'Failed to update profile', 'error');
                }
            } catch (error) {
                showMessage('profileMessage', 'Network error. Please try again.', 'error');
                console.error('Update profile error:', error);
            }
        }

        // Load todos
        async function loadTodos() {
            try {
                const response = await apiCall(`${API_URL}/todos`);
                if (response && response.ok) {
                    todos = await response.json();
                    renderTodos();
                } else {
                    showMessage('todosMessage', 'Failed to load todos', 'error');
                }
            } catch (error) {
                console.error('Load todos error:', error);
            }
        }

        // Add todo
        async function addTodo() {
            const input = document.getElementById('todoInput');
            const title = input.value.trim();

            if (!title) return;

            try {
                const response = await apiCall(`${API_URL}/todos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });

                if (response && response.ok) {
                    const newTodo = await response.json();
                    todos.unshift(newTodo);
                    renderTodos();
                    input.value = '';
                }
            } catch (error) {
                console.error('Add todo error:', error);
            }
        }

        // Toggle todo
        async function toggleTodo(id) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            try {
                const response = await apiCall(`${API_URL}/todos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed: !todo.completed })
                });

                if (response && response.ok) {
                    const updatedTodo = await response.json();
                    todos = todos.map(t => t.id === id ? updatedTodo : t);
                    renderTodos();
                }
            } catch (error) {
                console.error('Toggle todo error:', error);
            }
        }

        // Delete todo
        async function deleteTodo(id) {
            if (!confirm('Delete this todo?')) return;

            try {
                const response = await apiCall(`${API_URL}/todos/${id}`, {
                    method: 'DELETE'
                });

                if (response && response.ok) {
                    todos = todos.filter(t => t.id !== id);
                    renderTodos();
                }
            } catch (error) {
                console.error('Delete todo error:', error);
            }
        }

        // Render todos
        function renderTodos() {
            const container = document.getElementById('todosContent');

            if (todos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ú®</div>
                        <p>No todos yet. Add one above!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <ul class="todos-list">
                    ${todos.map(todo => `
                        <li class="todo-item ${todo.completed ? 'completed' : ''}">
                            <input
                                type="checkbox"
                                class="todo-checkbox"
                                ${todo.completed ? 'checked' : ''}
                                onchange="toggleTodo('${todo.id}')"
                            >
                            <div class="todo-content">
                                <div class="todo-title">${escapeHtml(todo.title)}</div>
                                ${todo.description ? `<div class="todo-description">${escapeHtml(todo.description)}</div>` : ''}
                            </div>
                            <button class="delete-btn" onclick="deleteTodo('${todo.id}')">Delete</button>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        // Load admin users
        async function loadAdminUsers() {
            hideMessage('adminMessage');

            try {
                const response = await apiCall(`${API_URL}/admin/users`);
                if (response && response.ok) {
                    users = await response.json();
                    renderAdminUsers();
                } else {
                    const data = await response.json();
                    showMessage('adminMessage', data.error || 'Failed to load users', 'error');
                }
            } catch (error) {
                showMessage('adminMessage', 'Network error. Please try again.', 'error');
                console.error('Load users error:', error);
            }
        }

        // Render admin users
        function renderAdminUsers() {
            const container = document.getElementById('adminContent');

            container.innerHTML = `
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Verified</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${escapeHtml(user.email)}</td>
                                <td>${escapeHtml(user.name || '-')}</td>
                                <td><span class="role-badge ${user.role}">${user.role}</span></td>
                                <td>${user.isVerified ? '‚úì' : '‚úó'}</td>
                                <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                                <td>
                                    ${user.id !== currentUser.id ? `
                                        ${user.role === 'user' ? `
                                            <button class="action-btn promote" onclick="changeUserRole('${user.id}', 'admin')">Make Admin</button>
                                        ` : `
                                            <button class="action-btn demote" onclick="changeUserRole('${user.id}', 'user')">Remove Admin</button>
                                        `}
                                        <button class="action-btn delete" onclick="deleteUser('${user.id}')">Delete</button>
                                    ` : '<em>You</em>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Change user role
        async function changeUserRole(userId, role) {
            hideMessage('adminMessage');

            try {
                const response = await apiCall(`${API_URL}/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role })
                });

                if (response && response.ok) {
                    showMessage('adminMessage', `User role updated to ${role}`, 'success');
                    loadAdminUsers();
                } else {
                    const data = await response.json();
                    showMessage('adminMessage', data.error || 'Failed to update role', 'error');
                }
            } catch (error) {
                showMessage('adminMessage', 'Network error. Please try again.', 'error');
                console.error('Change role error:', error);
            }
        }

        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;

            hideMessage('adminMessage');

            try {
                const response = await apiCall(`${API_URL}/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                if (response && response.ok) {
                    showMessage('adminMessage', 'User deleted successfully', 'success');
                    loadAdminUsers();
                } else {
                    const data = await response.json();
                    showMessage('adminMessage', data.error || 'Failed to delete user', 'error');
                }
            } catch (error) {
                showMessage('adminMessage', 'Network error. Please try again.', 'error');
                console.error('Delete user error:', error);
            }
        }

        // Switch view
        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

            document.getElementById(view + 'View').classList.add('active');
            event.target.classList.add('active');

            if (view === 'todos') {
                loadTodos();
            } else if (view === 'profile') {
                updateUserDisplay();
            } else if (view === 'admin') {
                loadAdminUsers();
            }
        }

        // Handle todo keypress
        function handleTodoKeyPress(event) {
            if (event.key === 'Enter') {
                addTodo();
            }
        }

        // Logout
        function logout() {
            authToken = null;
            refreshToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('user');
            todos = [];
            showAuthView();
        }

        // Show app view
        function showAppView() {
            document.getElementById('authView').classList.remove('active');
            document.getElementById('todosView').classList.add('active');
            document.getElementById('navTabs').style.display = 'flex';
            document.getElementById('userBar').style.display = 'flex';
            document.querySelectorAll('.nav-tab')[0].classList.add('active');
            loadTodos();
        }

        // Show auth view
        function showAuthView() {
            document.getElementById('authView').classList.add('active');
            document.getElementById('todosView').classList.remove('active');
            document.getElementById('profileView').classList.remove('active');
            document.getElementById('adminView').classList.remove('active');
            document.getElementById('navTabs').style.display = 'none';
            document.getElementById('userBar').style.display = 'none';
            document.getElementById('adminNavTab').style.display = 'none';
            showLogin();
        }

        // Show/hide messages
        function showMessage(id, message, type) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.className = `message ${type} show`;
        }

        function hideMessage(id) {
            const el = document.getElementById(id);
            el.classList.remove('show');
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Dark mode toggle
        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');

            // Update toggle button icon
            const toggleBtn = document.querySelector('.theme-toggle');
            toggleBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // Initialize theme
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const shouldBeDark = savedTheme === 'dark' || (!savedTheme && prefersDark);

            if (shouldBeDark) {
                document.body.classList.add('dark-mode');
                const toggleBtn = document.querySelector('.theme-toggle');
                if (toggleBtn) toggleBtn.textContent = '‚òÄÔ∏è';
            }
        }

        // Initialize theme immediately
        initTheme();

        // Initialize on load
        init();
    </script>
</body>
</html>
