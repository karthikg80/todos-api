<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App - Complete</title>
    <style>
        :root {
            /* Light mode colors */
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --container-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border-color: #e0e0e0;
            --input-bg: #ffffff;
            --card-bg: #f8f9fa;
            --card-hover: #f0f1f3;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body.dark-mode {
            /* Dark mode colors */
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --container-bg: #0f3460;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border-color: #27272a;
            --input-bg: #18181b;
            --card-bg: #27272a;
            --card-hover: #3f3f46;
            --shadow: rgba(0, 0, 0, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
        }

        .container {
            background: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px var(--shadow);
            max-width: 800px;
            margin: 0 auto;
            overflow: hidden;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .user-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .verified-badge {
            background: rgba(46, 213, 115, 0.3);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .unverified-badge {
            background: rgba(255, 107, 107, 0.3);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .admin-badge {
            background: rgba(255, 218, 121, 0.3);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(180deg);
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95em;
            color: #6c757d;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            color: #667eea;
            background: white;
            border-bottom-color: #667eea;
        }

        .content {
            padding: 30px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .auth-container {
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #999;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .auth-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .link-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.9em;
            margin-top: 15px;
        }

        .link-btn:hover {
            color: #764ba2;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.error {
            background: #fee;
            color: #c33;
        }

        .message.success {
            background: #efe;
            color: #3c3;
        }

        .message.warning {
            background: #fffbeb;
            color: #f59e0b;
            border: 1px solid #fde68a;
        }

        .add-todo {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .add-todo input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .add-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .todos-list {
            list-style: none;
        }

        .todo-item {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            cursor: move;
        }

        .todo-item:hover {
            background: var(--card-hover);
        }

        .todo-item.completed {
            opacity: 0.6;
        }

        .todo-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .todo-item.drag-over {
            border-top: 3px solid #667eea;
        }

        .drag-handle {
            cursor: grab;
            font-size: 1.2em;
            color: var(--text-muted);
            user-select: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .bulk-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 4px;
        }

        .todo-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .todo-content {
            flex: 1;
        }

        .todo-title {
            font-weight: 500;
            color: var(--text-primary);
        }

        .todo-item.completed .todo-title {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .delete-btn {
            padding: 8px 16px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .delete-btn:hover {
            background: #ff3838;
        }

        .search-bar {
            margin-bottom: 15px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .bulk-actions-toolbar {
            background: #667eea;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .bulk-actions-toolbar button {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .bulk-actions-toolbar button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .bulk-count {
            margin-left: auto;
            font-size: 0.9em;
        }

        .keyboard-shortcuts-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s, background 0.3s;
            z-index: 1000;
        }

        .keyboard-shortcuts-btn:hover {
            background: #764ba2;
            transform: scale(1.1);
        }

        .shortcuts-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .shortcuts-overlay.active {
            display: flex;
        }

        .shortcuts-content {
            background: var(--container-bg);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .shortcuts-content h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .shortcut-key {
            background: var(--card-bg);
            padding: 6px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-weight: 600;
            color: var(--text-primary);
        }

        .shortcut-desc {
            color: var(--text-secondary);
            flex: 1;
            margin-right: 20px;
        }

        /* ========== PHASE E: ANIMATIONS & TRANSITIONS ========== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .todo-item {
            animation: slideIn 0.3s ease-out;
        }

        .todo-item.removing {
            animation: fadeOut 0.3s ease-out forwards;
        }

        .add-btn:active {
            animation: pulse 0.3s ease-out;
        }

        .delete-btn:active {
            animation: pulse 0.3s ease-out;
        }

        /* Undo/Redo Toast Notification */
        .undo-toast {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: #2d3436;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1500;
            animation: slideIn 0.3s ease-out;
        }

        .undo-toast.active {
            display: flex;
        }

        .undo-toast button {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        /* ========== PHASE E: RESPONSIVE MOBILE VIEW ========== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 12px;
                max-width: 100%;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .user-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .theme-toggle {
                align-self: flex-end;
            }

            .content {
                padding: 15px;
            }

            .add-todo {
                flex-direction: column;
                gap: 10px;
            }

            .add-todo input {
                width: 100%;
            }

            .add-btn {
                width: 100%;
            }

            .todo-item {
                flex-wrap: wrap;
                padding: 12px;
            }

            .todo-content {
                flex: 1 1 100%;
                order: 2;
                margin-top: 8px;
            }

            .delete-btn {
                order: 3;
                margin-top: 8px;
                width: 100%;
            }

            .drag-handle {
                font-size: 1.5em;
            }

            .bulk-actions-toolbar {
                flex-direction: column;
                align-items: flex-start;
            }

            .bulk-actions-toolbar button {
                width: 100%;
            }

            .bulk-count {
                margin-left: 0;
                margin-top: 8px;
            }

            .keyboard-shortcuts-btn {
                bottom: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 1.1em;
            }

            .shortcuts-content {
                padding: 20px;
                max-width: 90%;
                margin: 20px;
            }

            .undo-toast {
                bottom: 70px;
                right: 15px;
                left: 15px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.3em;
            }

            .nav-tabs {
                gap: 5px;
            }

            .nav-tab {
                padding: 8px 12px;
                font-size: 0.85em;
            }

            .todo-title {
                font-size: 0.95em;
            }

            .search-input {
                font-size: 0.9em;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .profile-section {
            margin-bottom: 30px;
        }

        .profile-section h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .info-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .info-value {
            color: var(--text-primary);
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-table th, .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .users-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .role-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .role-badge.admin {
            background: #fff3cd;
            color: #856404;
        }

        .role-badge.user {
            background: #d1ecf1;
            color: #0c5460;
        }

        .action-btn {
            padding: 6px 12px;
            margin: 0 4px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .action-btn.promote {
            background: #ffc107;
            color: #000;
        }

        .action-btn.demote {
            background: #6c757d;
            color: white;
        }

        .action-btn.delete {
            background: #dc3545;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .container {
                border-radius: 0;
            }

            .add-todo {
                flex-direction: column;
            }

            .users-table {
                font-size: 0.85em;
            }

            .action-btn {
                padding: 4px 8px;
                font-size: 0.75em;
            }
        }

        /* ========== PHASE B: PRIORITY, NOTES, SUBTASKS ========== */
        .priority-selector {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .priority-btn {
            padding: 8px 16px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .priority-btn:hover {
            transform: translateY(-2px);
        }

        .priority-btn.active {
            border-width: 2px;
        }

        .priority-btn.low {
            border-color: #48dbfb;
            color: #48dbfb;
        }

        .priority-btn.low.active {
            background: #48dbfb;
            color: white;
        }

        .priority-btn.medium {
            border-color: #ffa502;
            color: #ffa502;
        }

        .priority-btn.medium.active {
            background: #ffa502;
            color: white;
        }

        .priority-btn.high {
            border-color: #ff4757;
            color: #ff4757;
        }

        .priority-btn.high.active {
            background: #ff4757;
            color: white;
        }

        .priority-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .priority-badge.low {
            background: #48dbfb;
            color: white;
        }

        .priority-badge.medium {
            background: #ffa502;
            color: white;
        }

        .priority-badge.high {
            background: #ff4757;
            color: white;
        }

        .notes-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .notes-toggle {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 0.9em;
            padding: 4px 8px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .notes-toggle:hover {
            text-decoration: underline;
        }

        .notes-content {
            margin-top: 8px;
            padding: 8px;
            background: var(--card-bg);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.9em;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .notes-textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9em;
            resize: vertical;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .subtasks-section {
            margin-top: 12px;
        }

        .subtask-list {
            list-style: none;
            margin-top: 8px;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: var(--card-bg);
            border-radius: 4px;
            margin-bottom: 4px;
            transition: background 0.2s;
        }

        .subtask-item:hover {
            background: var(--card-hover);
        }

        .subtask-item.completed {
            opacity: 0.6;
        }

        .subtask-item.completed .subtask-title {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .subtask-title {
            flex: 1;
            color: var(--text-primary);
            font-size: 0.9em;
        }

        .subtask-delete {
            background: none;
            border: none;
            color: #ff4757;
            cursor: pointer;
            font-size: 1.1em;
            padding: 2px 6px;
            opacity: 0.6;
        }

        .subtask-delete:hover {
            opacity: 1;
        }

        .add-subtask-form {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .add-subtask-input {
            flex: 1;
            padding: 6px 10px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.85em;
        }

        .add-subtask-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .add-subtask-btn:hover {
            background: #5568d3;
        }

        .expand-section {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            padding: 6px 8px;
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 0.85em;
            transition: color 0.2s;
            width: fit-content;
        }

        .expand-section:hover {
            color: #5568d3;
        }

        .expand-icon {
            font-size: 0.8em;
            transition: transform 0.3s;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>üìù Todo App</h1>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">üåô</button>
            </div>
            <div class="user-bar" id="userBar" style="display: none;">
                <div class="user-info">
                    <span id="userEmail"></span>
                    <span id="verifiedBadge"></span>
                    <span id="adminBadge"></span>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Navigation Tabs (only visible when logged in) -->
        <div class="nav-tabs" id="navTabs" style="display: none;">
            <button class="nav-tab active" onclick="switchView('todos')">Todos</button>
            <button class="nav-tab" onclick="switchView('profile')">Profile</button>
            <button class="nav-tab" id="adminNavTab" style="display: none;" onclick="switchView('admin')">Admin</button>
        </div>

        <div class="content">
            <!-- Authentication View -->
            <div id="authView" class="view active">
                <div class="auth-container">
                    <div class="auth-tabs">
                        <button class="auth-tab active" onclick="switchAuthTab('login', this)">Login</button>
                        <button class="auth-tab" onclick="switchAuthTab('register', this)">Register</button>
                    </div>

                    <div class="message" id="authMessage"></div>

                    <!-- Login Form -->
                    <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)" style="display: block;">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="loginEmail" required placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <button type="submit" class="btn">Login</button>
                        <button type="button" class="link-btn" onclick="showForgotPassword()">Forgot Password?</button>
                    </form>

                    <!-- Register Form -->
                    <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)" style="display: none;">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="registerName" placeholder="Your Name (optional)">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="registerEmail" required placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="registerPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8">
                        </div>
                        <button type="submit" class="btn">Create Account</button>
                    </form>

                    <!-- Forgot Password Form -->
                    <form id="forgotPasswordForm" class="auth-form" onsubmit="handleForgotPassword(event)" style="display: none;">
                        <h2 style="margin-bottom: 20px;">Reset Password</h2>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="forgotEmail" required placeholder="your@email.com">
                        </div>
                        <button type="submit" class="btn">Send Reset Link</button>
                        <button type="button" class="link-btn" onclick="showLogin()">Back to Login</button>
                    </form>

                    <!-- Reset Password Form -->
                    <form id="resetPasswordForm" class="auth-form" onsubmit="handleResetPassword(event)" style="display: none;">
                        <h2 style="margin-bottom: 20px;">Set New Password</h2>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" id="newPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password</label>
                            <input type="password" id="confirmPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8">
                        </div>
                        <button type="submit" class="btn">Reset Password</button>
                    </form>
                </div>
            </div>

            <!-- Todos View -->
            <div id="todosView" class="view">
                <!-- Search Bar -->
                <div class="search-bar">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search todos... (Ctrl/Cmd+F)" oninput="filterTodos()">
                    <span class="search-icon">üîç</span>
                </div>

                <!-- Category Filter -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <label style="font-weight: 500; color: var(--text-primary);">Filter:</label>
                    <select id="categoryFilter" onchange="filterTodos()" style="padding: 8px 12px; border: 2px solid var(--border-color); border-radius: 6px; background: var(--input-bg); color: var(--text-primary); cursor: pointer;">
                        <option value="">All Categories</option>
                    </select>
                    <button onclick="clearFilters()" style="padding: 8px 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; color: var(--text-primary);">Clear</button>
                </div>

                <!-- Bulk Actions Toolbar -->
                <div id="bulkActionsToolbar" class="bulk-actions-toolbar" style="display: none;">
                    <input type="checkbox" id="selectAllCheckbox" class="bulk-checkbox" onchange="toggleSelectAll()">
                    <label for="selectAllCheckbox" style="cursor: pointer; user-select: none;">Select All</label>
                    <button onclick="completeSelected()">‚úì Complete Selected</button>
                    <button onclick="deleteSelected()">üóë Delete Selected</button>
                    <span class="bulk-count" id="bulkCount">0 selected</span>
                </div>

                <!-- Add Todo Form -->
                <div class="add-todo" style="flex-direction: column; gap: 12px;">
                    <input type="text" id="todoInput" placeholder="What needs to be done?" onkeypress="handleTodoKeyPress(event)" style="width: 100%;">
                    <div style="display: flex; gap: 10px; width: 100%; flex-wrap: wrap;">
                        <input type="text" id="todoCategoryInput" placeholder="Category (e.g., Work, Personal)" style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                        <input type="datetime-local" id="todoDueDateInput" style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <label style="font-weight: 500; color: var(--text-primary);">Priority:</label>
                        <div class="priority-selector">
                            <button class="priority-btn low" onclick="setPriority('low')" id="priorityLow">Low</button>
                            <button class="priority-btn medium active" onclick="setPriority('medium')" id="priorityMedium">Medium</button>
                            <button class="priority-btn high" onclick="setPriority('high')" id="priorityHigh">High</button>
                        </div>
                        <button class="add-btn" onclick="addTodo()" style="margin-left: auto;">Add Todo</button>
                    </div>
                    <div>
                        <button class="expand-section" onclick="toggleNotesInput()">
                            <span class="expand-icon" id="notesExpandIcon">‚ñ∂</span>
                            <span>Add notes (optional)</span>
                        </button>
                        <textarea id="todoNotesInput" class="notes-textarea" placeholder="Add detailed notes here..." style="display: none; margin-top: 8px;"></textarea>
                    </div>
                </div>

                <div id="todosContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading todos...
                    </div>
                </div>
            </div>

            <!-- Profile View -->
            <div id="profileView" class="view">
                <div class="message" id="profileMessage"></div>

                <!-- Email Verification Banner -->
                <div id="verificationBanner" style="display: none; background: #fff3cd; border: 1px solid #ffc107; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #856404;">‚ö†Ô∏è Email Not Verified</strong>
                            <p style="color: #856404; margin-top: 4px; font-size: 0.9em;">Please verify your email address to access all features.</p>
                        </div>
                        <button onclick="resendVerification()" style="padding: 8px 16px; background: #ffc107; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            Resend Email
                        </button>
                    </div>
                </div>

                <div class="profile-section">
                    <h3>Account Information</h3>
                    <div class="info-row">
                        <span class="info-label">Email:</span>
                        <span class="info-value" id="profileEmail"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Name:</span>
                        <span class="info-value" id="profileName"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="profileStatus"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Member Since:</span>
                        <span class="info-value" id="profileCreated"></span>
                    </div>
                </div>

                <div class="profile-section">
                    <h3>Update Profile</h3>
                    <form onsubmit="handleUpdateProfile(event)">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="updateName" placeholder="Your Name">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="updateEmail" required placeholder="your@email.com">
                        </div>
                        <button type="submit" class="btn">Update Profile</button>
                    </form>
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="view">
                <div class="message" id="adminMessage"></div>
                <h2>User Management</h2>
                <div id="adminContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading users...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000'
            : window.location.origin;

        let currentUser = null;
        let authToken = null;
        let refreshToken = null;
        let todos = [];
        let users = [];

        // Initialize app
        function init() {
            // Check for reset token in URL
            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('token');

            if (resetToken) {
                showResetPassword(resetToken);
                return;
            }

            const token = localStorage.getItem('authToken');
            const refresh = localStorage.getItem('refreshToken');
            const user = localStorage.getItem('user');

            if (token && user) {
                authToken = token;
                refreshToken = refresh;
                currentUser = JSON.parse(user);
                showAppView();
                loadUserProfile();
            }
        }

        // API call with auto-refresh
        async function apiCall(url, options = {}) {
            if (!options.headers) options.headers = {};
            if (authToken && !options.skipAuth) {
                options.headers['Authorization'] = `Bearer ${authToken}`;
            }

            let response = await fetch(url, options);

            // Handle token expiration
            if (response.status === 401 && refreshToken && !options.skipRefresh) {
                const refreshed = await refreshAccessToken();
                if (refreshed) {
                    options.headers['Authorization'] = `Bearer ${authToken}`;
                    response = await fetch(url, options);
                } else {
                    logout();
                    return response;
                }
            }

            // If no refresh token is available, clear stale auth state on unauthorized responses.
            if (response.status === 401 && !refreshToken && !options.skipAuth) {
                logout();
            }

            return response;
        }

        // Refresh access token
        async function refreshAccessToken() {
            try {
                const response = await fetch(`${API_URL}/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    refreshToken = data.refreshToken;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    return true;
                }
            } catch (error) {
                console.error('Token refresh failed:', error);
            }
            return false;
        }

        // Switch auth tabs
        function switchAuthTab(tab, triggerEl) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.style.display = 'none');

            if (triggerEl) {
                triggerEl.classList.add('active');
            }
            document.getElementById(tab + 'Form').style.display = 'block';
            hideMessage('authMessage');
        }

        // Show forgot password form
        function showForgotPassword() {
            document.querySelectorAll('.auth-form').forEach(f => f.style.display = 'none');
            document.getElementById('forgotPasswordForm').style.display = 'block';
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            hideMessage('authMessage');
        }

        // Show login form
        function showLogin() {
            document.querySelectorAll('.auth-form').forEach(f => f.style.display = 'none');
            document.getElementById('loginForm').style.display = 'block';
            document.querySelectorAll('.auth-tab')[0].classList.add('active');
            hideMessage('authMessage');
        }

        // Show reset password form
        function showResetPassword(token) {
            document.getElementById('resetPasswordForm').dataset.token = token;
            document.querySelectorAll('.auth-form').forEach(f => f.style.display = 'none');
            document.getElementById('resetPasswordForm').style.display = 'block';
        }

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();
            hideMessage('authMessage');

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    refreshToken = data.refreshToken;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    if (refreshToken) localStorage.setItem('refreshToken', refreshToken);
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    showAppView();
                    loadUserProfile();
                } else {
                    showMessage('authMessage', data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showMessage('authMessage', 'Network error. Please try again.', 'error');
                console.error('Login error:', error);
            }
        }

        // Handle registration
        async function handleRegister(event) {
            event.preventDefault();
            hideMessage('authMessage');

            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            const payload = { email, password };
            if (name) payload.name = name;

            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    refreshToken = data.refreshToken;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    if (refreshToken) localStorage.setItem('refreshToken', refreshToken);
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    showMessage('authMessage', 'Account created successfully!', 'success');
                    setTimeout(() => {
                        showAppView();
                        loadUserProfile();
                    }, 1000);
                } else {
                    if (data.errors) {
                        const errorMsg = data.errors.map(e => e.message).join(', ');
                        showMessage('authMessage', errorMsg, 'error');
                    } else {
                        showMessage('authMessage', data.error || 'Registration failed', 'error');
                    }
                }
            } catch (error) {
                showMessage('authMessage', 'Network error. Please try again.', 'error');
                console.error('Registration error:', error);
            }
        }

        // Handle forgot password
        async function handleForgotPassword(event) {
            event.preventDefault();
            hideMessage('authMessage');

            const email = document.getElementById('forgotEmail').value;

            try {
                const response = await fetch(`${API_URL}/auth/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('authMessage', data.message || 'Reset link sent! Check your email.', 'success');
                    setTimeout(showLogin, 3000);
                } else {
                    showMessage('authMessage', data.error || 'Failed to send reset link', 'error');
                }
            } catch (error) {
                showMessage('authMessage', 'Network error. Please try again.', 'error');
                console.error('Forgot password error:', error);
            }
        }

        // Handle reset password
        async function handleResetPassword(event) {
            event.preventDefault();
            hideMessage('authMessage');

            const token = document.getElementById('resetPasswordForm').dataset.token;
            const password = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;

            if (password !== confirm) {
                showMessage('authMessage', 'Passwords do not match', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, password })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('authMessage', 'Password reset successfully! Redirecting to login...', 'success');
                    setTimeout(() => {
                        window.location.href = window.location.pathname;
                    }, 2000);
                } else {
                    showMessage('authMessage', data.error || 'Failed to reset password', 'error');
                }
            } catch (error) {
                showMessage('authMessage', 'Network error. Please try again.', 'error');
                console.error('Reset password error:', error);
            }
        }

        // Load user profile
        async function loadUserProfile() {
            try {
                const response = await apiCall(`${API_URL}/users/me`);
                if (response && response.ok) {
                    const user = await response.json();
                    currentUser = { ...currentUser, ...user };
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    updateUserDisplay();

                    // Check if admin and show admin tab
                    if (user.role === 'admin') {
                        document.getElementById('adminNavTab').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Load profile error:', error);
            }
        }

        // Update user display
        function updateUserDisplay() {
            document.getElementById('userEmail').textContent = currentUser.email;

            const verifiedBadge = document.getElementById('verifiedBadge');
            if (currentUser.isVerified) {
                verifiedBadge.className = 'verified-badge';
                verifiedBadge.textContent = '‚úì Verified';
            } else {
                verifiedBadge.className = 'unverified-badge';
                verifiedBadge.textContent = 'Not Verified';
            }

            const adminBadge = document.getElementById('adminBadge');
            if (currentUser.role === 'admin') {
                adminBadge.className = 'admin-badge';
                adminBadge.textContent = '‚≠ê Admin';
                adminBadge.style.display = 'inline-block';
            } else {
                adminBadge.style.display = 'none';
            }

            // Update profile view
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileName').textContent = currentUser.name || 'Not set';
            document.getElementById('profileStatus').textContent = currentUser.isVerified ? 'Verified ‚úì' : 'Not Verified';
            document.getElementById('profileCreated').textContent = new Date(currentUser.createdAt).toLocaleDateString();
            document.getElementById('updateName').value = currentUser.name || '';
            document.getElementById('updateEmail').value = currentUser.email;

            // Show/hide verification banner
            const verificationBanner = document.getElementById('verificationBanner');
            if (verificationBanner) {
                verificationBanner.style.display = currentUser.isVerified ? 'none' : 'block';
            }
        }

        // Resend verification email
        async function resendVerification() {
            hideMessage('profileMessage');

            if (!currentUser || !currentUser.email) {
                showMessage('profileMessage', 'User email not found', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/resend-verification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('profileMessage', 'Verification email sent! Please check your inbox.', 'success');
                } else {
                    showMessage('profileMessage', data.error || 'Failed to send verification email', 'error');
                }
            } catch (error) {
                showMessage('profileMessage', 'Network error. Please try again.', 'error');
                console.error('Resend verification error:', error);
            }
        }

        // Handle update profile
        async function handleUpdateProfile(event) {
            event.preventDefault();
            hideMessage('profileMessage');

            const name = document.getElementById('updateName').value;
            const email = document.getElementById('updateEmail').value;

            try {
                const response = await apiCall(`${API_URL}/users/me`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name || null, email })
                });

                if (response && response.ok) {
                    const updatedUser = await response.json();
                    currentUser = { ...currentUser, ...updatedUser };
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    updateUserDisplay();
                    showMessage('profileMessage', 'Profile updated successfully!', 'success');
                } else {
                    const data = await response.json();
                    showMessage('profileMessage', data.error || 'Failed to update profile', 'error');
                }
            } catch (error) {
                showMessage('profileMessage', 'Network error. Please try again.', 'error');
                console.error('Update profile error:', error);
            }
        }

        // Load todos
        async function loadTodos() {
            try {
                const response = await apiCall(`${API_URL}/todos`);
                if (response && response.ok) {
                    todos = await response.json();

                    // DEBUG: Log what API returned
                    console.log('üì• Loaded todos from API:', todos.length);
                    todos.forEach((todo, i) => {
                        console.log(`Todo ${i}:`, {
                            id: todo.id,
                            title: todo.title,
                            priority: todo.priority,
                            notes: todo.notes,
                            notesLength: todo.notes ? todo.notes.length : 0
                        });
                    });

                    renderTodos();
                    updateCategoryFilter();
                } else {
                    todos = [];
                    selectedTodos.clear();
                    renderTodos();
                    updateCategoryFilter();
                    showMessage('todosMessage', 'Failed to load todos', 'error');
                }
            } catch (error) {
                todos = [];
                selectedTodos.clear();
                renderTodos();
                updateCategoryFilter();
                console.error('Load todos error:', error);
            }
        }

        // Add todo
        async function addTodo() {
            const input = document.getElementById('todoInput');
            const categoryInput = document.getElementById('todoCategoryInput');
            const dueDateInput = document.getElementById('todoDueDateInput');
            const notesInput = document.getElementById('todoNotesInput');

            const title = input.value.trim();
            if (!title) return;

            const payload = {
                title,
                priority: currentPriority
            };

            if (categoryInput.value.trim()) {
                payload.category = categoryInput.value.trim();
            }
            if (dueDateInput.value) {
                payload.dueDate = new Date(dueDateInput.value).toISOString();
            }
            if (notesInput.value.trim()) {
                payload.notes = notesInput.value.trim();
            }

            try {
                const response = await apiCall(`${API_URL}/todos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response && response.ok) {
                    const newTodo = await response.json();
                    todos.unshift(newTodo);
                    renderTodos();
                    updateCategoryFilter();

                    // Clear form
                    input.value = '';
                    categoryInput.value = '';
                    dueDateInput.value = '';
                    notesInput.value = '';

                    // Reset priority to medium
                    setPriority('medium');

                    // Hide notes input
                    notesInput.style.display = 'none';
                    document.getElementById('notesExpandIcon').classList.remove('expanded');
                }
            } catch (error) {
                console.error('Add todo error:', error);
            }
        }

        // Toggle todo
        async function toggleTodo(id, forceValue = null) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            const newCompletedValue = forceValue !== null ? forceValue : !todo.completed;

            try {
                const response = await apiCall(`${API_URL}/todos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed: newCompletedValue })
                });

                if (response && response.ok) {
                    const updatedTodo = await response.json();
                    todos = todos.map(t => t.id === id ? updatedTodo : t);
                    renderTodos();

                    // Add undo action only if user initiated (not programmatic)
                    if (forceValue === null && newCompletedValue) {
                        addUndoAction('complete', { id }, 'Todo marked as complete');
                    }
                }
            } catch (error) {
                console.error('Toggle todo error:', error);
            }
        }

        // Delete todo
        async function deleteTodo(id) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            if (!confirm('Delete this todo?')) return;

            // Store todo data for undo
            const todoData = { ...todo };

            try {
                const response = await apiCall(`${API_URL}/todos/${id}`, {
                    method: 'DELETE'
                });

                if (response && response.ok) {
                    todos = todos.filter(t => t.id !== id);
                    selectedTodos.delete(id);
                    renderTodos();
                    updateCategoryFilter();

                    // Add undo action
                    addUndoAction('delete', todoData, 'Todo deleted');
                    await loadTodos();
                    return;
                }

                const errorData = response ? await response.json().catch(() => ({})) : {};
                showMessage('todosMessage', errorData.error || 'Failed to delete todo', 'error');
            } catch (error) {
                showMessage('todosMessage', 'Network error while deleting todo', 'error');
                console.error('Delete todo error:', error);
            }
        }

        // Update category filter dropdown
        function updateCategoryFilter() {
            const categories = [...new Set(todos.map(t => t.category).filter(Boolean))];
            const filterSelect = document.getElementById('categoryFilter');
            const currentValue = filterSelect.value;

            filterSelect.innerHTML = '<option value="">All Categories</option>' +
                categories.map(cat => `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`).join('');

            if (categories.includes(currentValue)) {
                filterSelect.value = currentValue;
            }
        }

        // Filter todos by category and search
        function filterTodosList(todosList) {
            let filtered = todosList;

            // Category filter
            const categoryFilter = document.getElementById('categoryFilter').value;
            if (categoryFilter) {
                filtered = filtered.filter(todo => todo.category === categoryFilter);
            }

            // Search filter
            const searchQuery = document.getElementById('searchInput')?.value.toLowerCase().trim();
            if (searchQuery) {
                filtered = filtered.filter(todo =>
                    todo.title.toLowerCase().includes(searchQuery) ||
                    (todo.description && todo.description.toLowerCase().includes(searchQuery)) ||
                    (todo.category && todo.category.toLowerCase().includes(searchQuery))
                );
            }

            return filtered;
        }

        // Called when filter changes
        function filterTodos() {
            renderTodos();
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('categoryFilter').value = '';
            document.getElementById('searchInput').value = '';
            renderTodos();
        }

        // Render todos
        function renderTodos() {
            const container = document.getElementById('todosContent');

            // Debug: Log todos with notes
            const todosWithNotes = todos.filter(t => t.notes);
            if (todosWithNotes.length > 0) {
                console.log('Todos with notes:', todosWithNotes.map(t => ({id: t.id, title: t.title, notes: t.notes})));
            }

            if (todos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ú®</div>
                        <p>No todos yet. Add one above!</p>
                    </div>
                `;
                updateBulkActionsVisibility();
                return;
            }

            const filteredTodos = filterTodosList(todos);

            container.innerHTML = `
                <ul class="todos-list">
                    ${filteredTodos.map((todo, index) => {
                        const isOverdue = todo.dueDate && !todo.completed && new Date(todo.dueDate) < new Date();
                        const dueDateStr = todo.dueDate ? new Date(todo.dueDate).toLocaleString() : '';
                        const isSelected = selectedTodos.has(todo.id);

                        return `
                        <li class="todo-item ${todo.completed ? 'completed' : ''}"
                            draggable="true"
                            data-todo-id="${todo.id}"
                            ondragstart="handleDragStart(event)"
                            ondragover="handleDragOver(event)"
                            ondrop="handleDrop(event)"
                            ondragend="handleDragEnd(event)">
                            <input
                                type="checkbox"
                                class="bulk-checkbox"
                                ${isSelected ? 'checked' : ''}
                                onchange="toggleSelectTodo('${todo.id}')"
                                onclick="event.stopPropagation()"
                            >
                            <span class="drag-handle">‚ãÆ‚ãÆ</span>
                            <input
                                type="checkbox"
                                class="todo-checkbox"
                                ${todo.completed ? 'checked' : ''}
                                onchange="toggleTodo('${todo.id}')"
                            >
                            <div class="todo-content" style="flex: 1;">
                                <div class="todo-title">${escapeHtml(todo.title)}</div>
                                ${todo.description ? `<div class="todo-description">${escapeHtml(todo.description)}</div>` : ''}
                                <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; align-items: center;">
                                    ${getPriorityIcon(todo.priority)} <span class="priority-badge ${todo.priority}">${todo.priority.toUpperCase()}</span>
                                    ${todo.category ? `<span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">üè∑Ô∏è ${escapeHtml(todo.category)}</span>` : ''}
                                    ${todo.dueDate ? `<span style="background: ${isOverdue ? '#ff4757' : '#48dbfb'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">${isOverdue ? '‚ö†Ô∏è' : 'üìÖ'} ${dueDateStr}</span>` : ''}
                                </div>
                                ${todo.subtasks && todo.subtasks.length > 0 ? renderSubtasks(todo) : ''}
                                ${todo.notes && todo.notes.trim() ? `
                                    <div class="notes-section">
                                        <button class="notes-toggle" onclick="toggleNotes('${todo.id}', event)">
                                            <span class="expand-icon" id="notes-icon-${todo.id}">‚ñ∂</span>
                                            <span>üìù Notes</span>
                                        </button>
                                        <div class="notes-content" id="notes-content-${todo.id}" style="display: none;">
                                            ${escapeHtml(String(todo.notes))}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <button class="delete-btn" onclick="deleteTodo('${todo.id}')">Delete</button>
                        </li>
                    `}).join('')}
                </ul>
            `;

            updateBulkActionsVisibility();
        }

        // ========== PHASE B: PRIORITY, NOTES, SUBTASKS ==========
        let currentPriority = 'medium';

        function handleTodoKeyPress(event) {
            if (event.key === 'Enter') {
                addTodo();
            }
        }

        function setPriority(priority) {
            currentPriority = priority;

            // Update button states
            document.querySelectorAll('.priority-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`priority${priority.charAt(0).toUpperCase() + priority.slice(1)}`).classList.add('active');
        }

        function getPriorityIcon(priority) {
            const icons = {
                high: 'üî¥',
                medium: 'üü°',
                low: 'üü¢'
            };
            return icons[priority] || icons.medium;
        }

        function toggleNotesInput() {
            const notesInput = document.getElementById('todoNotesInput');
            const icon = document.getElementById('notesExpandIcon');

            if (notesInput.style.display === 'none') {
                notesInput.style.display = 'block';
                icon.classList.add('expanded');
            } else {
                notesInput.style.display = 'none';
                icon.classList.remove('expanded');
            }
        }

        function toggleNotes(todoId, event) {
            event.stopPropagation();
            const content = document.getElementById(`notes-content-${todoId}`);
            const icon = document.getElementById(`notes-icon-${todoId}`);

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.add('expanded');
            } else {
                content.style.display = 'none';
                icon.classList.remove('expanded');
            }
        }

        function renderSubtasks(todo) {
            const completedCount = todo.subtasks.filter(s => s.completed).length;
            const totalCount = todo.subtasks.length;

            return `
                <div class="subtasks-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                        <span style="font-size: 0.85em; color: var(--text-secondary);">
                            ‚òëÔ∏è Subtasks: ${completedCount}/${totalCount}
                        </span>
                    </div>
                    <ul class="subtask-list">
                        ${todo.subtasks.map(subtask => `
                            <li class="subtask-item ${subtask.completed ? 'completed' : ''}">
                                <input
                                    type="checkbox"
                                    class="todo-checkbox"
                                    style="width: 16px; height: 16px;"
                                    ${subtask.completed ? 'checked' : ''}
                                    onchange="toggleSubtask('${todo.id}', '${subtask.id}')"
                                >
                                <span class="subtask-title">${escapeHtml(subtask.title)}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        async function toggleSubtask(todoId, subtaskId) {
            const todo = todos.find(t => t.id === todoId);
            if (!todo || !todo.subtasks) return;

            const subtask = todo.subtasks.find(s => s.id === subtaskId);
            if (!subtask) return;

            try {
                const response = await apiCall(`${API_URL}/todos/${todoId}/subtasks/${subtaskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed: !subtask.completed })
                });

                if (response && response.ok) {
                    const updatedSubtask = await response.json();
                    todo.subtasks = todo.subtasks.map(s => s.id === subtaskId ? updatedSubtask : s);
                    renderTodos();
                }
            } catch (error) {
                console.error('Toggle subtask failed:', error);
            }
        }

        // ========== PHASE A: DRAG & DROP FUNCTIONALITY ==========
        let draggedTodoId = null;
        let draggedOverTodoId = null;

        function handleDragStart(e) {
            draggedTodoId = e.target.dataset.todoId;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            const todoId = e.currentTarget.dataset.todoId;
            if (todoId !== draggedTodoId) {
                e.currentTarget.classList.add('drag-over');
                draggedOverTodoId = todoId;
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();

            const dropTargetId = e.currentTarget.dataset.todoId;
            e.currentTarget.classList.remove('drag-over');

            if (draggedTodoId && dropTargetId && draggedTodoId !== dropTargetId) {
                reorderTodos(draggedTodoId, dropTargetId);
            }
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.todo-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedTodoId = null;
            draggedOverTodoId = null;
        }

        async function reorderTodos(draggedId, targetId) {
            const draggedIndex = todos.findIndex(t => t.id === draggedId);
            const targetIndex = todos.findIndex(t => t.id === targetId);

            if (draggedIndex === -1 || targetIndex === -1) return;

            // Reorder in local array
            const [draggedTodo] = todos.splice(draggedIndex, 1);
            todos.splice(targetIndex, 0, draggedTodo);

            // Update order values
            todos.forEach((todo, index) => {
                todo.order = index;
            });

            renderTodos();

            // Persist complete ordering on backend in a single request.
            try {
                const response = await apiCall(`${API_URL}/todos/reorder`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(
                        todos.map((todo) => ({ id: todo.id, order: todo.order }))
                    )
                });

                if (!response || !response.ok) {
                    console.error('Failed to persist full todo ordering, reloading from server');
                    await loadTodos();
                }
            } catch (error) {
                console.error('Failed to update todo order:', error);
                await loadTodos();
            }
        }

        // ========== PHASE A: BULK ACTIONS ==========
        let selectedTodos = new Set();

        function toggleSelectTodo(todoId) {
            if (selectedTodos.has(todoId)) {
                selectedTodos.delete(todoId);
            } else {
                selectedTodos.add(todoId);
            }
            updateBulkActionsVisibility();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const filteredTodos = filterTodosList(todos);

            if (selectAllCheckbox.checked) {
                filteredTodos.forEach(todo => selectedTodos.add(todo.id));
            } else {
                filteredTodos.forEach(todo => selectedTodos.delete(todo.id));
            }

            renderTodos();
        }

        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const filteredTodos = filterTodosList(todos);
            const allSelected = filteredTodos.length > 0 && filteredTodos.every(todo => selectedTodos.has(todo.id));

            selectAllCheckbox.checked = allSelected;
        }

        function updateBulkActionsVisibility() {
            const toolbar = document.getElementById('bulkActionsToolbar');
            const bulkCount = document.getElementById('bulkCount');

            if (selectedTodos.size > 0) {
                toolbar.style.display = 'flex';
                bulkCount.textContent = `${selectedTodos.size} selected`;
            } else {
                toolbar.style.display = 'none';
            }

            updateSelectAllCheckbox();
        }

        async function completeSelected() {
            if (selectedTodos.size === 0) return;

            const selectedIds = Array.from(selectedTodos);
            const completedIds = [];

            for (const todoId of selectedIds) {
                try {
                    const response = await apiCall(`${API_URL}/todos/${todoId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ completed: true })
                    });

                    if (response && response.ok) {
                        const todo = todos.find(t => t.id === todoId);
                        if (todo) {
                            todo.completed = true;
                            completedIds.push(todoId);
                        }
                    }
                } catch (error) {
                    console.error('Failed to complete todo:', error);
                }
            }

            if (completedIds.length > 0) {
                addUndoAction('bulk-complete', completedIds, `${completedIds.length} todos marked as complete`);
            }

            selectedTodos.clear();
            renderTodos();
        }

        async function deleteSelected() {
            if (selectedTodos.size === 0) return;

            if (!confirm(`Delete ${selectedTodos.size} selected todo(s)?`)) return;

            const selectedIds = Array.from(selectedTodos);
            const deletedTodos = [];
            let deletedCount = 0;

            for (const todoId of selectedIds) {
                try {
                    const response = await apiCall(`${API_URL}/todos/${todoId}`, {
                        method: 'DELETE'
                    });

                    if (response && response.ok) {
                        const todo = todos.find(t => t.id === todoId);
                        if (todo) {
                            deletedTodos.push({ ...todo });
                        }
                        todos = todos.filter(t => t.id !== todoId);
                        deletedCount += 1;
                    } else {
                        const errorData = response ? await response.json().catch(() => ({})) : {};
                        console.error('Failed to delete todo:', todoId, errorData.error || 'Unknown error');
                    }
                } catch (error) {
                    console.error('Failed to delete todo:', error);
                }
            }

            if (deletedTodos.length > 0) {
                addUndoAction('bulk-delete', deletedTodos, `${deletedTodos.length} todos deleted`);
            }

            selectedTodos.clear();
            renderTodos();
            updateCategoryFilter();
            if (deletedCount > 0) {
                await loadTodos();
            }
        }

        // ========== PHASE A: KEYBOARD SHORTCUTS ==========
        function toggleShortcuts() {
            const overlay = document.getElementById('shortcutsOverlay');
            overlay.classList.toggle('active');
        }

        function closeShortcutsOverlay(event) {
            if (event.target.id === 'shortcutsOverlay') {
                toggleShortcuts();
            }
        }

        // ========== PHASE E: UNDO/REDO FUNCTIONALITY ==========
        let undoStack = [];
        let undoTimeout = null;

        function addUndoAction(action, data, message) {
            undoStack.push({ action, data, timestamp: Date.now() });

            // Keep only last 10 actions
            if (undoStack.length > 10) {
                undoStack.shift();
            }

            showUndoToast(message);
        }

        function showUndoToast(message) {
            const toast = document.getElementById('undoToast');
            const messageEl = document.getElementById('undoMessage');

            messageEl.textContent = message;
            toast.classList.add('active');

            // Clear existing timeout
            if (undoTimeout) {
                clearTimeout(undoTimeout);
            }

            // Hide after 5 seconds
            undoTimeout = setTimeout(() => {
                toast.classList.remove('active');
            }, 5000);
        }

        function performUndo() {
            if (undoStack.length === 0) return;

            const lastAction = undoStack.pop();
            const toast = document.getElementById('undoToast');
            toast.classList.remove('active');

            switch (lastAction.action) {
                case 'delete':
                    // Restore deleted todo
                    restoreTodo(lastAction.data);
                    break;
                case 'complete':
                    // Uncomplete todo
                    toggleTodo(lastAction.data.id, false);
                    break;
                case 'bulk-delete':
                    // Restore multiple todos
                    lastAction.data.forEach(todo => restoreTodo(todo));
                    break;
                case 'bulk-complete':
                    // Uncomplete multiple todos
                    lastAction.data.forEach(todoId => toggleTodo(todoId, false));
                    break;
            }
        }

        async function restoreTodo(todoData) {
            try {
                const createPayload = {
                    title: todoData.title,
                    description: todoData.description,
                    category: todoData.category,
                    dueDate: todoData.dueDate,
                    priority: todoData.priority,
                    notes: todoData.notes,
                };

                const response = await apiCall(`${API_URL}/todos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(createPayload)
                });

                if (response && response.ok) {
                    const newTodo = await response.json();
                    let todoToRender = newTodo;

                    // Preserve state that is not supported in create payload.
                    if (todoData.completed === true || Number.isInteger(todoData.order)) {
                        const updateResponse = await apiCall(`${API_URL}/todos/${newTodo.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                completed: !!todoData.completed,
                                ...(Number.isInteger(todoData.order) ? { order: todoData.order } : {})
                            })
                        });

                        if (updateResponse && updateResponse.ok) {
                            todoToRender = await updateResponse.json();
                        }
                    }

                    todos.push(todoToRender);
                    todos.sort((a, b) => {
                        const aOrder = Number.isInteger(a.order) ? a.order : Number.MAX_SAFE_INTEGER;
                        const bOrder = Number.isInteger(b.order) ? b.order : Number.MAX_SAFE_INTEGER;
                        return aOrder - bOrder;
                    });
                    renderTodos();
                    updateCategoryFilter();
                }
            } catch (error) {
                console.error('Failed to restore todo:', error);
            }
        }

        document.addEventListener('keydown', function(e) {
            // Ignore if typing in input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                // Allow Esc to clear search
                if (e.key === 'Escape' && e.target.id === 'searchInput') {
                    e.target.value = '';
                    filterTodos();
                    e.target.blur();
                }
                return;
            }

            // Ctrl/Cmd + N: Focus on new todo input
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                document.getElementById('todoInput')?.focus();
            }

            // Ctrl/Cmd + F: Focus on search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput')?.focus();
            }

            // Ctrl/Cmd + A: Select all todos
            if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                e.preventDefault();
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = true;
                    toggleSelectAll();
                }
            }

            // ?: Show keyboard shortcuts
            if (e.key === '?') {
                e.preventDefault();
                toggleShortcuts();
            }
        });

        // Load admin users
        async function loadAdminUsers() {
            hideMessage('adminMessage');

            try {
                const response = await apiCall(`${API_URL}/admin/users`);
                if (response && response.ok) {
                    users = await response.json();
                    renderAdminUsers();
                } else {
                    const data = await response.json();
                    showMessage('adminMessage', data.error || 'Failed to load users', 'error');
                }
            } catch (error) {
                showMessage('adminMessage', 'Network error. Please try again.', 'error');
                console.error('Load users error:', error);
            }
        }

        // Render admin users
        function renderAdminUsers() {
            const container = document.getElementById('adminContent');

            container.innerHTML = `
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Verified</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${escapeHtml(user.email)}</td>
                                <td>${escapeHtml(user.name || '-')}</td>
                                <td><span class="role-badge ${user.role}">${user.role}</span></td>
                                <td>${user.isVerified ? '‚úì' : '‚úó'}</td>
                                <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                                <td>
                                    ${user.id !== currentUser.id ? `
                                        ${user.role === 'user' ? `
                                            <button class="action-btn promote" onclick="changeUserRole('${user.id}', 'admin')">Make Admin</button>
                                        ` : `
                                            <button class="action-btn demote" onclick="changeUserRole('${user.id}', 'user')">Remove Admin</button>
                                        `}
                                        <button class="action-btn delete" onclick="deleteUser('${user.id}')">Delete</button>
                                    ` : '<em>You</em>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Change user role
        async function changeUserRole(userId, role) {
            hideMessage('adminMessage');

            try {
                const response = await apiCall(`${API_URL}/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role })
                });

                if (response && response.ok) {
                    showMessage('adminMessage', `User role updated to ${role}`, 'success');
                    loadAdminUsers();
                } else {
                    const data = await response.json();
                    showMessage('adminMessage', data.error || 'Failed to update role', 'error');
                }
            } catch (error) {
                showMessage('adminMessage', 'Network error. Please try again.', 'error');
                console.error('Change role error:', error);
            }
        }

        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;

            hideMessage('adminMessage');

            try {
                const response = await apiCall(`${API_URL}/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                if (response && response.ok) {
                    showMessage('adminMessage', 'User deleted successfully', 'success');
                    loadAdminUsers();
                } else {
                    const data = await response.json();
                    showMessage('adminMessage', data.error || 'Failed to delete user', 'error');
                }
            } catch (error) {
                showMessage('adminMessage', 'Network error. Please try again.', 'error');
                console.error('Delete user error:', error);
            }
        }

        // Switch view
        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

            document.getElementById(view + 'View').classList.add('active');
            event.target.classList.add('active');

            if (view === 'todos') {
                loadTodos();
            } else if (view === 'profile') {
                updateUserDisplay();
            } else if (view === 'admin') {
                loadAdminUsers();
            }
        }

        // Handle todo keypress
        function handleTodoKeyPress(event) {
            if (event.key === 'Enter') {
                addTodo();
            }
        }

        // Logout
        async function logout() {
            const tokenToRevoke = refreshToken || localStorage.getItem('refreshToken');

            if (tokenToRevoke) {
                fetch(`${API_URL}/auth/logout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken: tokenToRevoke })
                }).catch((error) => {
                    console.error('Logout token revocation failed:', error);
                });
            }

            authToken = null;
            refreshToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('user');
            todos = [];
            showAuthView();
        }

        // Show app view
        function showAppView() {
            document.getElementById('authView').classList.remove('active');
            document.getElementById('todosView').classList.add('active');
            document.getElementById('navTabs').style.display = 'flex';
            document.getElementById('userBar').style.display = 'flex';
            document.querySelectorAll('.nav-tab')[0].classList.add('active');
            // Prevent previous account data from flashing while fetching current user's data.
            todos = [];
            selectedTodos.clear();
            renderTodos();
            updateCategoryFilter();
            loadTodos();
        }

        // Show auth view
        function showAuthView() {
            document.getElementById('authView').classList.add('active');
            document.getElementById('todosView').classList.remove('active');
            document.getElementById('profileView').classList.remove('active');
            document.getElementById('adminView').classList.remove('active');
            document.getElementById('navTabs').style.display = 'none';
            document.getElementById('userBar').style.display = 'none';
            document.getElementById('adminNavTab').style.display = 'none';
            showLogin();
        }

        // Show/hide messages
        function showMessage(id, message, type) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.className = `message ${type} show`;
        }

        function hideMessage(id) {
            const el = document.getElementById(id);
            el.classList.remove('show');
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Dark mode toggle
        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');

            // Update toggle button icon
            const toggleBtn = document.querySelector('.theme-toggle');
            toggleBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // Initialize theme
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const shouldBeDark = savedTheme === 'dark' || (!savedTheme && prefersDark);

            if (shouldBeDark) {
                document.body.classList.add('dark-mode');
                const toggleBtn = document.querySelector('.theme-toggle');
                if (toggleBtn) toggleBtn.textContent = '‚òÄÔ∏è';
            }
        }

        // ========== PHASE E: SERVICE WORKER REGISTRATION ==========
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                const shouldRegister =
                    window.location.protocol === 'https:' &&
                    window.location.hostname !== 'localhost';

                if (!shouldRegister) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map((registration) => registration.unregister()));
                    return;
                }

                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Initialize theme immediately
        initTheme();

        // Initialize on load
        init();
    </script>

    <!-- Keyboard Shortcuts Button -->
    <button class="keyboard-shortcuts-btn" onclick="toggleShortcuts()" title="Keyboard Shortcuts (?)">‚å®Ô∏è</button>

    <!-- Undo/Redo Toast -->
    <div id="undoToast" class="undo-toast">
        <span id="undoMessage">Action performed</span>
        <button onclick="performUndo()">Undo</button>
    </div>

    <!-- Keyboard Shortcuts Overlay -->
    <div id="shortcutsOverlay" class="shortcuts-overlay" onclick="closeShortcutsOverlay(event)">
        <div class="shortcuts-content" onclick="event.stopPropagation()">
            <h2>‚å®Ô∏è Keyboard Shortcuts</h2>
            <div class="shortcut-item">
                <span class="shortcut-desc">New Todo</span>
                <kbd class="shortcut-key">Ctrl/Cmd + N</kbd>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-desc">Search Todos</span>
                <kbd class="shortcut-key">Ctrl/Cmd + F</kbd>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-desc">Clear Search</span>
                <kbd class="shortcut-key">Esc</kbd>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-desc">Show Shortcuts</span>
                <kbd class="shortcut-key">?</kbd>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-desc">Select All Todos</span>
                <kbd class="shortcut-key">Ctrl/Cmd + A</kbd>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="toggleShortcuts()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>
</body>
</html>
